<tool id="fgbio_groupreadsbyumi" name="fgbio GroupReadsByUmi" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>- groups reads together that appear to have come from the same original molecule</description>
    <macros>
        <import>../macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="stdio"/>
    <expand macro="version_command"/>
    <command><![CDATA[
        ## Link input BAM file
        ln -s '$input' input.bam &&
        
        fgbio GroupReadsByUmi
        --input input.bam
        --output output.bam
        --strategy $strategy
        #if $raw_tag:
            --raw-tag '$raw_tag'
        #end if
        #if $assign_tag:
            --assign-tag '$assign_tag'
        #end if
        #if $min_map_q:
            --min-map-q $min_map_q
        #end if
        #if $include_non_pf_reads:
            --include-non-pf-reads
        #end if
        #if $edits:
            --edits $edits
        #end if
        #if $min_umi_length:
            --min-umi-length $min_umi_length
        #end if
        #if $allow_inter_contig:
            --allow-inter-contig
        #end if
        #if $family_size_histogram:
            --family-size-histogram family_size_histogram.txt
        #end if
    ]]></command>
    <inputs>
        <param name="input" type="data" format="bam,sam" label="Input BAM/SAM file"/>
        <param name="strategy" type="select" label="UMI assignment strategy">
            <option value="Identity">Identity - only reads with identical UMI sequences are grouped together</option>
            <option value="Edit">Edit - reads are clustered by edit distance</option>
            <option value="Adjacency" selected="true">Adjacency - directed adjacency method allowing errors with count gradient</option>
            <option value="Paired">Paired - for methods producing template with UMI pairs (A-B related to B-A)</option>
        </param>
        <param name="raw_tag" type="text" value="RX" label="Raw UMI tag" help="The tag containing the raw UMI"/>
        <param name="assign_tag" type="text" value="MI" label="Assigned UMI tag" help="The output tag for UMI grouping"/>
        <param name="min_map_q" type="integer" min="0" value="1" label="Minimum mapping quality" help="Minimum mapping quality for mapped reads"/>
        <param name="include_non_pf_reads" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Include non-PF reads" help="Include reads that do not pass quality filters"/>
        <param name="edits" type="integer" min="0" value="1" label="Edit distance" help="The allowable number of edits between UMIs"/>
        <param name="min_umi_length" type="integer" optional="true" min="1" label="Minimum UMI length" help="The minimum UMI length. If not specified then all UMIs must have the same length"/>
        <param name="allow_inter_contig" type="boolean" truevalue="true" falsevalue="false" checked="true" label="Allow inter-contig reads" help="DEPRECATED: this option will be removed in future versions and inter-contig reads will be automatically processed"/>
        <param name="family_size_histogram" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Output family size histogram" help="Generate optional output of tag family size counts"/>
    </inputs>
    <outputs>
        <data name="output" format="bam" from_work_dir="output.bam" label="${tool.name} on ${on_string}: output"/>
        <data name="histogram" format="txt" from_work_dir="family_size_histogram.txt" label="${tool.name} on ${on_string}: family size histogram">
            <filter>family_size_histogram</filter>
        </data>
    </outputs>
    <tests>
        <test>
            <param name="input" value="test_input.bam"/>
            <param name="strategy" value="Adjacency"/>
            <output name="output" file="test_output.bam"/>
        </test>
    </tests>
    <help><![CDATA[
**What it does**

GroupReadsByUmi groups reads together that appear to have come from the same original molecule. Reads are grouped by template, and then templates are sorted by the 5' mapping positions of the reads from the template. Reads that have the same end positions are then sub-grouped by UMI sequence.

**Input Requirements**

- Accepts reads in any order (including 'unsorted')
- If the input is not template-coordinate sorted, the tool will re-sort the input

**Output**

The output is sorted by:
1. The lower genome coordinate of the two outer ends of the templates
2. The sequencing library
3. The assigned UMI tag
4. Read Name

**Filtering**

During grouping, reads are filtered out if:
- All reads with the same queryname are unmapped
- Any primary read has mapping quality < min-map-q (default=1)
- The primary mappings for R1 and R2 are on different chromosomes and allow-inter-contig is false

**UMI Grouping Strategies**

1. **Identity**: Only reads with identical UMI sequences are grouped together. Useful for evaluation but should generally be avoided as it generates multiple UMI groups per original molecule in the presence of errors.

2. **Edit**: Reads are clustered into groups such that each read within a group has at least one other read in the group with â‰¤ edits differences. Effective when there are small numbers of reads per UMI.

3. **Adjacency**: A version of the directed adjacency method that allows for errors between UMIs but only when there is a count gradient. This is the recommended default strategy.

4. **Paired**: Similar to adjacency but for methods that produce templates with a pair of UMIs such that a read with A-B is related to but not identical to a read with B-A. Expects UMI pairs separated by hyphen (e.g. 'ACGT-CCGG').

**UMI Length Handling**

By default, all UMIs must be the same length. If min-umi-length is specified:
- Reads with UMIs shorter than the specified length will be discarded  
- When comparing UMIs of different lengths, the first N bases will be compared (where N is the length of the shortest UMI)
- The UMI length is the number of ACGT bases (excludes dashes and other non-ACGT characters)
- This option is not implemented for the paired strategy

**Tags**

- **Raw UMI tag**: The tag containing the raw UMI (default: RX)
- **Assigned UMI tag**: The output tag for UMI grouping (default: MI)

**Citation**

This tool is part of the fgbio toolkit. Please cite:

Fulcrum Genomics. (2019). fgbio: Tools for working with genomic and particularly sequencing data. Available at: https://github.com/fulcrumgenomics/fgbio
    ]]></help>
    <expand macro="citations"/>
</tool>