<tool id="fgbio_zipperbams" name="fgbio ZipperBams" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>- zips together an unmapped and mapped BAM to transfer metadata</description>
    <macros>
        <import>../macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="stdio"/>
    <expand macro="version_command"/>
    <command><![CDATA[
        @PREPARE_FASTA_IDX@
        
        ## Link input BAM files
        ln -s '$mapped' mapped.bam &&
        ln -s '$unmapped' unmapped.bam &&
        
        fgbio ZipperBams
        --input mapped.bam
        --unmapped unmapped.bam
        --output output.bam
        --ref \$reffa
        #if $tags_to_remove:
            #for $tag in str($tags_to_remove).split(','):
                --tags-to-remove '${tag.strip()}'
            #end for
        #end if
        #if $tags_to_reverse:
            #for $tag in str($tags_to_reverse).split(','):
                --tags-to-reverse '${tag.strip()}'
            #end for
        #end if
        #if $tags_to_revcomp:
            #for $tag in str($tags_to_revcomp).split(','):
                --tags-to-revcomp '${tag.strip()}'
            #end for
        #end if
        #if $sort_order:
            --sort $sort_order
        #end if
        #if $buffer:
            --buffer $buffer
        #end if
    ]]></command>
    <inputs>
        <param name="mapped" type="data" format="bam,sam" label="Mapped BAM/SAM file"/>
        <param name="unmapped" type="data" format="bam,sam" label="Unmapped BAM/SAM file"/>
        <expand macro="mandatory_reference" argument="--ref" help="Path to the reference used in alignment. Must have accompanying .dict file."/>
        <param name="tags_to_remove" type="text" optional="true" label="Tags to remove" help="Comma-separated list of tags to remove from the mapped BAM records"/>
        <param name="tags_to_reverse" type="text" optional="true" label="Tags to reverse" help="Comma-separated list of optional tags to reverse on reads mapped to the negative strand"/>
        <param name="tags_to_revcomp" type="text" optional="true" label="Tags to reverse complement" help="Comma-separated list of optional tags to reverse complement on reads mapped to the negative strand"/>
        <param name="sort_order" type="select" optional="true" label="Sort order" help="Sort the output BAM into the given order">
            <option value="">Same as input</option>
            <option value="Coordinate">Coordinate</option>
            <option value="Queryname">Queryname</option>
            <option value="Random">Random</option>
            <option value="RandomQuery">RandomQuery</option>
            <option value="TemplateCoordinate">TemplateCoordinate</option>
            <option value="Unsorted">Unsorted</option>
            <option value="Unknown">Unknown</option>
        </param>
        <param name="buffer" type="integer" optional="true" min="1" value="5000" label="Buffer size" help="Buffer this many read-pairs while reading the input BAMs"/>
    </inputs>
    <outputs>
        <data name="output" format="bam" from_work_dir="output.bam" label="${tool.name} on ${on_string}: output"/>
    </outputs>
    <tests>
        <test>
            <param name="mapped" value="test_mapped.bam"/>
            <param name="unmapped" value="test_unmapped.bam"/>
            <conditional name="addref_cond">
                <param name="addref_select" value="history"/>
                <param name="ref" value="test_ref.fa"/>
            </conditional>
            <output name="output" file="test_output.bam"/>
        </test>
    </tests>
    <help><![CDATA[
**What it does**

ZipperBams zips together an unmapped and mapped BAM to transfer metadata into the output BAM. This tool is useful when you have metadata (like UMIs or other tags) in an unmapped BAM that you want to transfer to a mapped BAM.

**Requirements**

Both the unmapped and mapped BAMs must be:
1. Queryname sorted or grouped (i.e. all records with the same name are grouped together in the file)
2. Have the same ordering of querynames

If either of these requirements are violated, the output is undefined.

**Tag Processing**

All tags present on the unmapped reads are transferred to the mapped reads. The tool provides options to:

- **Remove tags**: Specify tags to remove from the mapped BAM records
- **Reverse tags**: Tags on unmapped reads to be reversed before being copied to reads mapped to the negative strand  
- **Reverse complement tags**: Tags on unmapped reads to be reverse complemented before being copied to reads mapped to the negative strand

The options 'tags-to-reverse' and 'tags-to-revcomp' can take a mixture of two-letter tag names and the names of tag sets. Currently the only named tag set is "Consensus" which contains all the per-base consensus tags produced by fgbio consensus callers.

**Input and Output**

- **Mapped BAM**: The mapped BAM file (can be from stdin in command line)
- **Unmapped BAM**: The unmapped BAM file containing metadata to transfer
- **Reference**: The reference genome used for alignment (required)

The output BAM file is emitted in the same order as the input BAMs unless overridden with the sort option.

**Citation**

This tool is part of the fgbio toolkit. Please cite:

Fulcrum Genomics. (2019). fgbio: Tools for working with genomic and particularly sequencing data. Available at: https://github.com/fulcrumgenomics/fgbio
    ]]></help>
    <expand macro="citations"/>
</tool>